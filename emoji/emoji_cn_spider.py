start_urls = ["https://dict.emojiall.com/zh-hans/sub-categories/A1",
              "https://dict.emojiall.com/zh-hans/sub-categories/A2",
              "https://dict.emojiall.com/zh-hans/sub-categories/A3",
              "https://dict.emojiall.com/zh-hans/sub-categories/A4",
              "https://dict.emojiall.com/zh-hans/sub-categories/A5",
              "https://dict.emojiall.com/zh-hans/sub-categories/A6",
              "https://dict.emojiall.com/zh-hans/sub-categories/A7",
              "https://dict.emojiall.com/zh-hans/sub-categories/A8",
              "https://dict.emojiall.com/zh-hans/sub-categories/A9",
              "https://dict.emojiall.com/zh-hans/sub-categories/A10",
              "https://dict.emojiall.com/zh-hans/sub-categories/A11",
              "https://dict.emojiall.com/zh-hans/sub-categories/A12",
              "https://dict.emojiall.com/zh-hans/sub-categories/A13",
              "https://dict.emojiall.com/zh-hans/sub-categories/A14",
              "https://dict.emojiall.com/zh-hans/sub-categories/A15",
              "https://dict.emojiall.com/zh-hans/sub-categories/B1",
              "https://dict.emojiall.com/zh-hans/sub-categories/B2",
              "https://dict.emojiall.com/zh-hans/sub-categories/B3",
              "https://dict.emojiall.com/zh-hans/sub-categories/B4",
              "https://dict.emojiall.com/zh-hans/sub-categories/B5",
              "https://dict.emojiall.com/zh-hans/sub-categories/B6",
              "https://dict.emojiall.com/zh-hans/sub-categories/B7",
              "https://dict.emojiall.com/zh-hans/sub-categories/B8",
              "https://dict.emojiall.com/zh-hans/sub-categories/B9",
              "https://dict.emojiall.com/zh-hans/sub-categories/B10",
              "https://dict.emojiall.com/zh-hans/sub-categories/B11",
              "https://dict.emojiall.com/zh-hans/sub-categories/B12",
              "https://dict.emojiall.com/zh-hans/sub-categories/B13",
              "https://dict.emojiall.com/zh-hans/sub-categories/B14",
              "https://dict.emojiall.com/zh-hans/sub-categories/B15",
              "https://dict.emojiall.com/zh-hans/sub-categories/B16",
              "https://dict.emojiall.com/zh-hans/sub-categories/C1",
              "https://dict.emojiall.com/zh-hans/sub-categories/C2",
              "https://dict.emojiall.com/zh-hans/sub-categories/D1",
              "https://dict.emojiall.com/zh-hans/sub-categories/D2",
              "https://dict.emojiall.com/zh-hans/sub-categories/D3",
              "https://dict.emojiall.com/zh-hans/sub-categories/D4",
              "https://dict.emojiall.com/zh-hans/sub-categories/D5",
              "https://dict.emojiall.com/zh-hans/sub-categories/D6",
              "https://dict.emojiall.com/zh-hans/sub-categories/D7",
              "https://dict.emojiall.com/zh-hans/sub-categories/D8",
              "https://dict.emojiall.com/zh-hans/sub-categories/E1",
              "https://dict.emojiall.com/zh-hans/sub-categories/E2",
              "https://dict.emojiall.com/zh-hans/sub-categories/E3",
              "https://dict.emojiall.com/zh-hans/sub-categories/E4",
              "https://dict.emojiall.com/zh-hans/sub-categories/E5",
              "https://dict.emojiall.com/zh-hans/sub-categories/E6",
              "https://dict.emojiall.com/zh-hans/sub-categories/E7",
              "https://dict.emojiall.com/zh-hans/sub-categories/E8",
              "https://dict.emojiall.com/zh-hans/sub-categories/F1",
              "https://dict.emojiall.com/zh-hans/sub-categories/F2",
              "https://dict.emojiall.com/zh-hans/sub-categories/F3",
              "https://dict.emojiall.com/zh-hans/sub-categories/F4",
              "https://dict.emojiall.com/zh-hans/sub-categories/F5",
              "https://dict.emojiall.com/zh-hans/sub-categories/F6",
              "https://dict.emojiall.com/zh-hans/sub-categories/F7",
              "https://dict.emojiall.com/zh-hans/sub-categories/F8",
              "https://dict.emojiall.com/zh-hans/sub-categories/F9",
              "https://dict.emojiall.com/zh-hans/sub-categories/F10",
              "https://dict.emojiall.com/zh-hans/sub-categories/F11",
              "https://dict.emojiall.com/zh-hans/sub-categories/G1",
              "https://dict.emojiall.com/zh-hans/sub-categories/G2",
              "https://dict.emojiall.com/zh-hans/sub-categories/G3",
              "https://dict.emojiall.com/zh-hans/sub-categories/G4",
              "https://dict.emojiall.com/zh-hans/sub-categories/G5",
              "https://dict.emojiall.com/zh-hans/sub-categories/H1",
              "https://dict.emojiall.com/zh-hans/sub-categories/H2",
              "https://dict.emojiall.com/zh-hans/sub-categories/H3",
              "https://dict.emojiall.com/zh-hans/sub-categories/H4",
              "https://dict.emojiall.com/zh-hans/sub-categories/H5",
              "https://dict.emojiall.com/zh-hans/sub-categories/H6",
              "https://dict.emojiall.com/zh-hans/sub-categories/H7",
              "https://dict.emojiall.com/zh-hans/sub-categories/H8",
              "https://dict.emojiall.com/zh-hans/sub-categories/H9",
              "https://dict.emojiall.com/zh-hans/sub-categories/H10",
              "https://dict.emojiall.com/zh-hans/sub-categories/H11",
              "https://dict.emojiall.com/zh-hans/sub-categories/H12",
              "https://dict.emojiall.com/zh-hans/sub-categories/H13",
              "https://dict.emojiall.com/zh-hans/sub-categories/H14",
              "https://dict.emojiall.com/zh-hans/sub-categories/H15",
              "https://dict.emojiall.com/zh-hans/sub-categories/H16",
              "https://dict.emojiall.com/zh-hans/sub-categories/H17",
              "https://dict.emojiall.com/zh-hans/sub-categories/H18",
              "https://dict.emojiall.com/zh-hans/sub-categories/I1",
              "https://dict.emojiall.com/zh-hans/sub-categories/I2",
              "https://dict.emojiall.com/zh-hans/sub-categories/I3",
              "https://dict.emojiall.com/zh-hans/sub-categories/I4",
              "https://dict.emojiall.com/zh-hans/sub-categories/I5",
              "https://dict.emojiall.com/zh-hans/sub-categories/I6",
              "https://dict.emojiall.com/zh-hans/sub-categories/I7",
              "https://dict.emojiall.com/zh-hans/sub-categories/I8",
              "https://dict.emojiall.com/zh-hans/sub-categories/I9",
              "https://dict.emojiall.com/zh-hans/sub-categories/I10",
              "https://dict.emojiall.com/zh-hans/sub-categories/I11",
              "https://dict.emojiall.com/zh-hans/sub-categories/J1",
              "https://dict.emojiall.com/zh-hans/sub-categories/J2",
              "https://dict.emojiall.com/zh-hans/sub-categories/J3", ]
import requests
import json
import os
import datetime
import pymysql
import redis
import pandas as pd
from scrapy import Selector
from sqlalchemy import create_engine


def get_mysql_connect():
    return pymysql.connect(
        host='localhost',  # mysql服务器地址
        port=3306,  # 端口号
        user='root',  # 用户名
        passwd='admin',  # 密码
        db='emoji_fun',  # 数据库名称
        charset='utf8',  # 连接编码，根据需要填写
    )


def update_mysql(connection, table, row):
    # 获取当天时间
    try:
        with connection.cursor() as cursor:
            # 先尝试删除当天存在的记录
            # sql = f"delete from {table} where create >= {date}"
            # cursor.execute(sql)
            # reminder_msg.append(f"删除当天已存在记录: {cursor.rowcount} 条")
            # 插入当天的新纪录
            sql = f"update `{table}` set longcode = '{row['longcode']}', name_ch = '{row[
                'name_ch']}', category='{row.get('category', '')}' where id = {row['id']}"
            cursor.execute(sql)
        connection.commit()
    except Exception as e:
        print(e)
        connection.rollback()
        return 0
    return 1


redis_server = redis.Redis(host="192.168.13.86")


class SpiderBase:
    name = "base"

    def __init__(self, cookies=None, headers=None):
        if headers is None:
            self._headers = {
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36",
                "Connection": "keep-alive"}
        else:
            self._headers = headers
        self._cookies = cookies
        self._session = requests.Session()

    @property
    def cookies(self):
        return self._cookies

    @property
    def session(self):
        return self._session

    @property
    def headers(self):
        return self._headers

    def crawl(self, **kwargs):
        raise NotImplemented()

    def verify_login_state(self, *args, **kwargs):
        """验证登录状态"""
        raise NotImplemented()

    def make_request(self, methods, url, **kwargs):
        """构造请求，若没给同名参数，默认传cookies和headers"""
        request_func = getattr(self._session, methods, None)
        assert request_func is not None
        request_kwargs = {}
        if self.cookies is not None:
            request_kwargs.update({"cookies": self.cookies})
        if self.headers is not None:
            request_kwargs.update({"headers": self.headers})
        request_kwargs.update(kwargs)
        return request_func(url, **request_kwargs)

    @classmethod
    def create_obj_cookies(cls, cookie_path):
        abs_path = os.path.join(cookie_path, cls.name + "_cookies.json")
        with open(abs_path) as f:
            cookies = json.load(f)
            return cls(cookies=cookies)

    @classmethod
    def get_last_days(cls, days=1, day_format="%Y-%m-%d"):
        today = datetime.datetime.now()
        today = datetime.datetime(year=today.year, month=today.month, day=today.day)
        delta = datetime.timedelta(days=days)
        lastday = today - delta
        return lastday.strftime(day_format)

    @classmethod
    def create_xpath_body(cls, text):
        return Selector(text=text)


class EmojiCnSpider(SpiderBase):
    emoji_xpath = "//span[@class='emoji_symbol']/a/@href"
    domain = "https://dict.emojiall.com"

    def run(self, start_urls):
        count = 0
        s = set()
        with open("cn_links.txt", "w") as f:
            for url in start_urls:
                resp = self.make_request("get", url)
                selector = Selector(response=resp)
                resp = selector.xpath("//span[@class='emoji_symbol']/a/@href").extract()
                print(resp)
                count += len(resp)
                s.update(set(resp))
                f.writelines([self.domain + i + "\n" for i in resp])
                print(count, len(resp), len(s))
                import time
                time.sleep(0.5)

    def get_exists_df(self):
        uri = "mysql+pymysql://%s:%s@%s:%s/%s?charset=utf8" % ("root", "admin", "localhost", 3306, "emoji_fun")
        engine = create_engine(uri)
        df = pd.read_sql("select id, name_en as name, codepoints, shortcode, tags, emoji from emoji_info", engine)
        return df

    def extract_items(self):
        prefix = "EMOJI"
        connection = get_mysql_connect()
        df = self.get_exists_df()
        for index, row in df.iterrows():
            key = prefix + ":" + str(row.id)
            row_id = row.id
            codepoints = row.codepoints.strip()
            longcode = "-".join([i.strip().replace("U+", "").rjust(4, "0") for i in codepoints.split(",")])
            if redis_server.get(key) == b"2":
                continue
            resp = self.make_request("get", "https://dict.emojiall.com/zh-hans/code/" + longcode)
            result = self.process_item(resp)
            result.update({"id": row_id, "longcode": longcode})
            print(result)
            if update_mysql(connection, "emoji_info", result) == 1:
                if len(result) > 0:
                    redis_server.set(key, "2")
            import time
            time.sleep(0.5)


if __name__ == '__main__':
    s = EmojiCnSpider()
    s.extract_items()
    # s.extract_emoji_urls()
    # s.run(start_urls)
